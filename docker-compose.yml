# ============================================
# DOCKER COMPOSE CONFIGURATION
# Event Booking Application with MongoDB Database
# ============================================
# This file orchestrates multiple containers:
# 1. Web Application (Next.js)
# 2. MongoDB Database (with persistent volume)

version: "3.8"

# ==========================================
# SERVICES DEFINITION
# ==========================================
services:
  # ==========================================
  # Event Booking Web Application
  # ==========================================
  eventbooking-app:
    # Container name for easy identification
    container_name: eventbooking-web
    
    # Build from local Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
    
    # Port mapping: host:container
    # Access application on http://localhost:3000
    ports:
      - "3000:3000"
    
    # Environment variables for the application
    environment:
      # Node environment
      - NODE_ENV=production
      
      # MongoDB connection string (MongoDB Atlas)
      - MONGODB_URI=${MONGODB_URI}
      
      # JWT Authentication secrets
      - ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET}
      - REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET}
      
      # Cloudinary configuration for image uploads
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      
      # Admin configuration
      - ADMIN_PIN=${ADMIN_PIN:-1004}
      
      # Application URL
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
    
    # Wait for MongoDB to be ready
    depends_on:
      - mongodb
    
    # Restart policy
    restart: unless-stopped
    
    # Custom network for service communication
    networks:
      - eventbooking-network

  # ==========================================
  # MongoDB Database Service
  # ==========================================
  mongodb:
    # Use official MongoDB image
    image: mongo:7.0
    
    # Container name
    container_name: eventbooking-db
    
    # Port mapping: host:container
    ports:
      - "27017:27017"
    
    # Environment variables for MongoDB
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=eventbooking123
      - MONGO_INITDB_DATABASE=eventbooking
    
    # Persistent volumes for database data
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    
    # Restart policy
    restart: unless-stopped
    
    # Network
    networks:
      - eventbooking-network
    
    # Health check
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

# ==========================================
# VOLUMES (Persistent Storage)
# ==========================================
volumes:
  # MongoDB data volume - persists even when containers are stopped/removed
  mongodb-data:
    driver: local
  
  # MongoDB configuration volume
  mongodb-config:
    driver: local

# ==========================================
# NETWORKS
# ==========================================
# Custom bridge network for inter-container communication
networks:
  eventbooking-network:
    driver: bridge
